# kafka 发送消息，保证消息顺序性

保证 kafka 消息的顺序性是指保证同一个 partition 中的消息有序，不同的 partition 不保证消息的顺序性的。为了实现这个目标，需要牺牲一部分性能，以换取消息有序。

为了尽可能提高发送消息的吞吐量，自然想到的方法是不要逐条的发送，而是使用批量方式发送消息。不过，kafka 客户端目前并没有提供批量发送消息的方法，例如，下面这样的方法在 kafka 客户端中并不存在：

```java
// 这样的方法在 kafka 客户端不存在
producer.send(List messsages);
```

不过，在 kafka producer 中有一个非常重要的参数 `batch.size` 它的值对消息发送的吞吐量有着非常大的影响，稍后将对这个参数进行详细的介绍。

同时，在向 kafka broker 发送消息时，作为客户端，底层采用的都是异步发送方式。

总结起来，要实现发送消息时，保持顺序性，需要我们在客户端异步方法基础上，借助批量方式发送消息，以提高吞吐量。


### 方法 1
使用 futrue，将异步方法变成同步调用的方式。

```java

Future future = producer.send(message);
future.get();

```

这种方式不推荐，因为每条消息的发送都需要同步的等待结果返回。

### 方法2
设置 kafka 客户端 producer 参数：

```properties
acks = all 或 -1（建议-1）
batch.size = 16384
linger.ms = 1
buffer.memory = 33554432
max.in.flight.requests.per.connection = 1
retries = 一个比较大的值

```

经过上述设置后，kafka 客户端每次向 partition 发送消息时，将采用批量方式发送，并且发送失败的情况下将根据设定的 `retries` 值重试发送。

同时，客户端可以不再使用 future.get() 同步等待。

```java
// 异步方法
producer.send(message, callback);
```

send() 方法会将消息暂存到 kafka 客户端的内存队列中，根据 `batch.size` 设定的值收集一批消息后，再批量发送出去。

| 参数名称                                  | 说明                                                                                                                                               |
| ------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------ |
| acks                                  | 保证 paritition leader 和副本都落盘成功                                                                                                                    |
| batch.size                            | 将多条消息聚合在一起，成批次发送                                                                                                                                 |
| linger.ms                             | 一个 batch 创建之后，需要等多久才将消息发送出去。如果设置成 0，表示一旦 batch 创建完成，就即刻发送，不管 batch 是否满。如果设置成大于0，表示等待设定的时间到了后再将 batch 发送。如果 batch 已满，但是设定的时间还未到，也会将这个 batch 发送出去。 |
| buffer.memory                         | 用来保存待发送出去的消息。一旦缓冲区被填满，producer 将处于阻塞状态，等待缓冲区有空闲内存被释放。但是这段阻塞时间不能超过 max.blocks.ms 设定的值。                                                            |
| max.in.flight.requests.per.connection | producer 底层是异步发送消息，消息生产出来后先进入 buffer，然后由异步IO线程负责发送。如果此参数设定成大于1，表示IO线程可以同时等待最多几个尚未 acks 的请求数。但是设置成大于1时，消息可能会发生乱序，因此此处设置成1，保证消息顺序性。                |
| retries                               | 消息发送失败后，重试次数                                                                                                                                     |


这种发送方式的吞吐量要远好于`方法 1`，推荐使用.

